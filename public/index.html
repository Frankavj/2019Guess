<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Guess my number</title>
    <link href="stylesheet.css" rel="stylesheet" type="text/css">
</head>

<body>

    <div>
        <h1>Guess my number!</h1>
        <div id="mainDiv">
            <div id="unameBox">Username: <input type="text" id="uname"></div>
            <input type="number" id="guess">
            <button id="btn">Go!</button>
        </div>
        <h4 id="hint"></h4>
    </div>

</body>
<script>

    let mainDiv = document.getElementById('mainDiv');
    let unameBox = document.getElementById('unameBox');
    let uname = document.getElementById('uname');
    let guess = document.getElementById('guess');
    let btn = document.getElementById('btn');
    let hint = document.getElementById('hint');

    let playing = false;

    btn.addEventListener('click', async function () {
        if (!playing) {
            // Check validity of username
            if (validName(uname.value)) {

                // Start the game -- the html part
                guess.style.display = "inline-block";
                btn.innerHTML = "Guess!";
                playing = true;

                // Start the game -- server part
                let resp = await fetch(`/start/${uname.value}`);
                if(resp.ok) {
                    let data = await resp.json();
                    unameBox.innerHTML = `Hello ${uname.value}, the number is between ${data.min} and ${data.max}`;
                }
            } else {
                uname.classList.add("error");
            }
        } else {
            // Check whether they got the right number
            if(guess.value) {
                let resp = await fetch(`/guess/${uname.value}/${guess.value}`, {method:"POST"});
                if(resp.ok) {
                    let data = await resp.json();
                    console.log(data);
                    if(data.code == 2000 || data.code == 2030) {
                        mainDiv.innerHTML = "Refresh the page to play again.";
                    }
                    hint.innerHTML = data.msg;
                }
            }
        }

    });

    function validName(name) {
        if (name.length == 0 || name.includes("/") || name.includes(" ")) {
            return false;
        }
        return true;
    }

    // if (uname && uname.value.length > 0) {
    //     fetch(`/start/${uname.value}`).then(
    //         function (response) {
    //             if (response.status != 200) {
    //                 console.log(`Status: ${response.status}`);
    //             } else {
    //                 response.json().then(function (data) {
    //                     console.log(data);
    //                 });
    //             }
    //         }
    //     ).catch(function (err) {
    //         console.log(`Fetch error: ${err}`);
    //     });
    // }

    // if (uname) {
    //     let name = uname.value;
    //     if (name.length > 0) {
    //         fetch(`/start/${name}`).then(resp => {
    //             if (resp.ok) {
    //                 resp.body.json()
    //             }
    //         }).then(json => {

    //         });
    //     }
    // }

    // function language(KEY) {
    //     // Remember this function needs to do something.
    // }



</script>

</html>